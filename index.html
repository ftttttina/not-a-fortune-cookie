<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="data:,">
  <title>Black Fortune | Mystery Unwrapped</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg-color: #050505;
      --paper-color: #c0c0c0;
      --base-scale: 1.32; 
      --glow-color: rgba(255, 250, 200, 0.6); 
    }

    body {
      margin: 0; background: var(--bg-color); color: #fff;
      font-family: "Palatino", serif; display: flex; flex-direction: column;
      justify-content: center; align-items: center; min-height: 100vh; 
      overflow: hidden; position: relative; touch-action: none;
    }

    /* --- 中央撕開包裝層 --- */
    .package-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 9999; display: flex; cursor: col-resize;
      transition: visibility 1.2s;
    }

    .package-wing {
      flex: 1; height: 100%; position: relative;
      background: rgba(255, 255, 255, 0.015);
      backdrop-filter: blur(25px) saturate(120%);
      -webkit-backdrop-filter: blur(25px) saturate(120%);
      transition: transform 1.2s cubic-bezier(0.8, 0, 0.2, 1), opacity 0.8s;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }

    .left-wing { border-right: 1px solid rgba(255,255,255,0.1); transform-origin: left center; }
    .right-wing { border-left: 1px solid rgba(255,255,255,0.1); transform-origin: right center; }

    /* 撕開時的動畫狀態 */
    .unwrapped .left-wing { transform: translateX(-100%) rotateY(-20deg); opacity: 0; }
    .unwrapped .right-wing { transform: translateX(100%) rotateY(20deg); opacity: 0; }

    /* 貫穿兩片的流光效果 */
    .plastic-shine {
      position: absolute; width: 200vw; height: 200vh;
      background: linear-gradient(135deg, 
        transparent 40%, 
        rgba(255,255,255,0.05) 45%, 
        rgba(255,255,255,0.18) 50%, 
        rgba(255,255,255,0.05) 55%, 
        transparent 60%);
      animation: shine-swipe 10s infinite linear;
      pointer-events: none; top: -50vh; left: -50vw;
    }

    .package-hint {
      position: absolute; width: 100%; text-align: center;
      bottom: 20%; color: rgba(255,255,255,0.4);
      font-size: 10px; letter-spacing: 8px; text-transform: uppercase;
      z-index: 10000; pointer-events: none;
    }

    /* 模擬撕開處的微弱箭頭 */
    .tear-guide {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      display: flex; gap: 40px; color: rgba(255,255,255,0.2); font-size: 20px;
    }
    .tear-guide span { animation: pulse 2s infinite; }

    @keyframes shine-swipe {
      0% { transform: translateX(-20%) rotate(0deg); }
      100% { transform: translateX(20%) rotate(360deg); }
    }
    @keyframes pulse { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.8; } }

    /* --- 遊戲主體內容 --- */
    #capture-area { 
      padding: 40px 20px; display: flex; flex-direction: column; align-items: center; 
      background: var(--bg-color); position: relative;
      transform: scale(0.9); filter: blur(10px); opacity: 0;
      transition: all 1.5s cubic-bezier(0.19, 1, 0.22, 1);
    }
    body.ready #capture-area { transform: scale(1); filter: blur(0); opacity: 1; }

    /* 其他 UI 與 餅乾樣式保持之前最優版本 */
    .header h1 { font-size: 22px; letter-spacing: 6px; font-weight: 300; margin: 0 0 25px 0; opacity: 0.7; text-transform: uppercase; }
    .flavor-tabs { display: flex; gap: 8px; margin-bottom: 35px; z-index: 10; flex-wrap: wrap; justify-content: center; }
    .tab-btn { background: transparent; border: 1px solid #333; color: #666; padding: 6px 12px; font-size: 10px; letter-spacing: 2px; cursor: pointer; transition: 0.4s; }
    .tab-btn.active { background: #eee; color: #000; border-color: #eee; }
    .cookie-box { position: relative; width: calc(260px * var(--base-scale)); height: calc(200px * var(--base-scale)); cursor: pointer; perspective: 1200px; z-index: 3; }
    .full-cookie { position: absolute; width: 100%; height: 100%; z-index: 5; transition: opacity 0.2s; }
    .full-cookie img { width: 100%; height: 100%; object-fit: contain; }
    .cookie-part { position: absolute; top: 0; width: 50%; height: 100%; overflow: hidden; opacity: 0; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s; z-index: 4; }
    .cookie-part img { position: absolute; width: 200%; height: 100%; object-fit: contain; }
    .left-part { left: 0; transform-origin: left bottom; clip-path: polygon(0% 0%, 100% 0%, 92% 15%, 100% 30%, 88% 45%, 95% 60%, 85% 75%, 100% 90%, 100% 100%, 0% 100%); }
    .right-part { right: 0; transform-origin: right bottom; clip-path: polygon(8% 15%, 0% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 90%, 15% 75%, 5% 60%, 12% 45%, 0% 30%); }
    .cookie-box.open .full-cookie { opacity: 0; }
    .cookie-box.open .cookie-part { opacity: 0.4; }
    .cookie-box.open .left-part { transform: translate(-145px, -35px) rotate(-32deg); }
    .cookie-box.open .right-part { transform: translate(145px, -35px) rotate(32deg); }
    .paper-strip { position: absolute; top: 50%; left: 50%; width: 0; height: 80px; background: var(--paper-color); transform: translate(-50%, -50%); z-index: 2; display: flex; justify-content: center; align-items: center; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: inset 0 0 15px rgba(0,0,0,0.2); clip-path: polygon(1% 4%, 98.5% 2%, 99.5% 96%, 1.5% 98%); overflow: hidden; visibility: hidden; }
    .cookie-box.open .paper-strip { width: 256px; visibility: visible; }
    .paper-text { color: #1a1a1a; opacity: 0; text-align: center; width: 88%; line-height: 1.4; transition: opacity 0.4s 0.6s; }
    .cookie-box.open .paper-text { opacity: 1; }
    #enText { font-size: 11.2px; font-style: italic; font-weight: bold; margin-bottom: 4px; color: #111; }
    #zhText { font-size: 8.1px; font-weight: 500; color: #333; }
    .divine-glow { position: absolute; top: 55%; left: 50%; width: 0; height: 0; background: radial-gradient(circle, var(--glow-color) 0%, transparent 70%); transform: translate(-50%, -50%); border-radius: 50%; filter: blur(40px); transition: all 1.2s ease-out; opacity: 0; z-index: 1; }
    .cookie-box.open ~ .divine-glow { width: 650px; height: 550px; opacity: 1; }
    .footer-note { position: absolute; bottom: 25px; width: 100%; text-align: center; font-size: 9px; color: #666; letter-spacing: 5px; text-transform: uppercase; opacity: 0.8; }
    .ui-layer { margin-top: 40px; display: flex; gap: 12px; z-index: 10; opacity: 0; transform: translateY(20px); transition: all 1s ease 0.5s; }
    body.ready .ui-layer { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .action-btn { background: transparent; color: #666; border: 1px solid #333; padding: 0 20px; cursor: pointer; font-size: 11px; height: 42px; min-width: 125px; }
    .particle { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: #444; pointer-events: none; z-index: 6; }
  </style>
</head>
<body>

  <div class="package-container" id="packageContainer">
    <div class="package-wing left-wing">
      <div class="plastic-shine"></div>
    </div>
    <div class="package-wing right-wing">
      <div class="plastic-shine" style="left: -150vw;"></div> </div>
    <div class="tear-guide">
      <span>←</span>
      <span>→</span>
    </div>
    <div class="package-hint">Swipe apart to open</div>
  </div>

  <div id="capture-area">
    <div class="header"><h1>Black Fortune</h1></div>
    <div class="flavor-tabs" id="flavorTabs">
      <button class="tab-btn active" onclick="setFlavor('life', this)">LIFE 生活</button>
      <button class="tab-btn" onclick="setFlavor('work', this)">WORK 職場</button>
      <button class="tab-btn" onclick="setFlavor('love', this)">LOVE 情感</button>
      <button class="tab-btn" onclick="setFlavor('money', this)">MONEY 金錢</button>
    </div>

    <div class="cookie-box" id="cookieBox">
      <div class="full-cookie"><img src="black-cookie.png" crossorigin="anonymous"></div>
      <div class="cookie-part left-part"><img src="black-cookie.png" crossorigin="anonymous"></div>
      <div class="cookie-part right-part"><img src="black-cookie.png" crossorigin="anonymous"></div>
      <div class="paper-strip">
        <div class="paper-text">
          <div id="enText"></div>
          <div id="zhText"></div>
        </div>
      </div>
    </div>
    <div class="divine-glow"></div>
    <div class="footer-note">If it hurts, it works</div>
  </div>

  <div class="ui-layer">
    <button class="action-btn" onclick="resetCookie()">RESET DESTINY</button>
    <button class="action-btn" onclick="saveImage()">SHARE WISDOM</button>
  </div>

  <script>
    const GITHUB_JSON_URL = 'https://raw.githubusercontent.com/ftttttina/not-a-fortune-cookie/refs/heads/main/fortunes.json';
    let fortunesData = null;
    let currentFlavor = 'life';
    let isLocked = false; 
    let isUnwrapped = false; 
    const box = document.getElementById('cookieBox');
    const container = document.getElementById('packageContainer');

    // --- 左右撕開交互邏輯 ---
    let startX = 0;
    
    container.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
    container.addEventListener('touchend', e => {
      let endX = e.changedTouches[0].clientX;
      // 只要檢測到明顯的水平移動（不論向左向右，模擬雙手撕開）
      if (Math.abs(startX - endX) > 60) {
        unwrap();
      }
    });
    // PC 端點擊也可以打開
    container.addEventListener('click', unwrap);

    function unwrap() {
      if (isUnwrapped) return;
      isUnwrapped = true;
      container.classList.add('unwrapped');
      document.body.classList.add('ready');
      setTimeout(() => { container.style.display = 'none'; }, 1200);
    }

    // --- 核心邏輯 ---
    fetch(GITHUB_JSON_URL).then(res => res.json()).then(data => { fortunesData = data; });

    function setFlavor(flavor, btn) {
      if (isLocked) return;
      currentFlavor = flavor;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (box.classList.contains('open')) resetCookie();
    }

    box.addEventListener('click', () => {
      if (!isUnwrapped || isLocked || !fortunesData || box.classList.contains('open')) return;
      isLocked = true;
      const list = fortunesData[currentFlavor];
      const item = list[Math.floor(Math.random() * list.length)];
      document.getElementById('enText').textContent = item.en;
      document.getElementById('zhText').textContent = item.zh;
      new Audio('crack.mp3').play().catch(()=>{});
      box.classList.add('open');
      createParticles(25);
      setTimeout(() => { isLocked = false; }, 950);
    });

    function resetCookie() {
      if (isLocked || !box.classList.contains('open')) return;
      isLocked = true;
      box.classList.remove('open');
      setTimeout(() => { isLocked = false; }, 850);
    }

    function saveImage() {
      if (!box.classList.contains('open')) return;
      const area = document.getElementById('capture-area');
      const originalTransform = area.style.transform;
      area.style.transform = "none";
      html2canvas(area, { backgroundColor: '#050505', scale: 2, useCORS: true }).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        if (navigator.userAgent.match(/(iPhone|iPod|iPad|Android)/i)) {
          const newWindow = window.open();
          newWindow.document.write(`<img src="${imgData}" style="width:100%;" />`);
        } else {
          const link = document.createElement('a');
          link.download = `fortune.png`;
          link.href = imgData;
          link.click();
        }
        area.style.transform = originalTransform;
      });
    }

    function createParticles(count) {
      for (let i = 0; i < count; i++) {
        const p = document.createElement('div');
        p.classList.add('particle');
        box.appendChild(p);
        const angle = Math.random() * Math.PI * 2;
        const velocity = 80 + Math.random() * 80;
        p.animate([{ transform: 'translate(-50%, -50%) scale(1)', opacity: 1 }, { transform: `translate(calc(-50% + ${Math.cos(angle)*velocity}px), calc(-50% + ${Math.sin(angle)*velocity}px)) scale(0)`, opacity: 0 }], { duration: 800, fill: 'forwards' });
        setTimeout(() => p.remove(), 800);
      }
    }
  </script>
</body>
</html>
